<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView â€¢ NotÃ­cias</title>
  <link rel="stylesheet" href="./pv.css">
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">PV</div>
        <div>
          <h1>NotÃ­cias locais</h1>
          <p>Manchetes leves e Ãºteis â€¢ mostra a fonte</p>
        </div>
      </div>
      <div class="status">
        <div class="pill"><span class="dot" id="netDot"></span><span id="netText">Online</span></div>
        <div class="pill"><span id="clockNow">--:--</span></div>
        <div class="pill">Troca: <span id="rot">20</span>s</div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="cardTop">
          <div class="tag"><span class="icon">ðŸ“°</span><span>NotÃ­cia</span></div>
          <div class="pill">Sem tragÃ©dia/polÃ­tica pesada</div>
        </div>

        <div class="content fadeIn" id="content">
          <img id="newsImg" alt="" style="width:100%; max-height:48vh; object-fit:cover; border-radius:14px; border:1px solid rgba(255,255,255,.10); display:none;">
          <div class="headline" id="headline">Carregandoâ€¦</div>
          <div class="summary" id="summary">Aguarde.</div>
          <div class="metaRow" id="metaRow">
            <div class="metaChip" id="sourceChip">Fonte: â€”</div>
            <div class="metaChip" id="timeChip">Publicado: â€”</div>
          </div>
        </div>

        <div class="footer">
          <div>PontoView â€¢ Vyre</div>
          <div id="footerRight">Atualizado: â€”</div>
        </div>
      </div>
    </div>
  </div>

<script>
const ROTATE_SECONDS = 20;
document.getElementById("rot").textContent = ROTATE_SECONDS;

const $ = (id)=>document.getElementById(id);
function updateClock(){ $("clockNow").textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}); }
setInterval(updateClock, 1000); updateClock();

function setNetUI(online){
  $("netDot").classList.toggle("off", !online);
  $("netText").textContent = online ? "Online" : "Offline";
}
setNetUI(navigator.onLine);
addEventListener("online",()=>setNetUI(true));
addEventListener("offline",()=>setNetUI(false));

function fmtDateTime(d){
  try{
    const dt = (d instanceof Date) ? d : new Date(d);
    return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
  }catch{return "â€”";}
}
function clampText(txt,max){
  if(!txt) return "";
  const s = String(txt).replace(/\s+/g," ").trim();
  return s.length>max ? s.slice(0,max-1)+"â€¦" : s;
}

const STORAGE_LAST = "pv_news_last_id_v1";

function getLastId(){ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} }
function setLastId(id){ try{localStorage.setItem(STORAGE_LAST, id||"")}catch{} }

async function loadNews(){
  // cache bust para evitar pegar versÃ£o antiga do GH Pages / SW
  const url = "./data/news.json?v=" + Date.now();
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP "+res.status);
  const data = await res.json();
  const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
  const generatedAt = data.generatedAt || new Date().toISOString();
  return { items, generatedAt };
}

function pickNext(items){
  if(!items.length) return null;
  const last = getLastId();
  const shuffled = items.slice().sort(()=>Math.random()-0.5);
  return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
}

function render(item, generatedAt){
  const c = $("content");
  c.classList.remove("fadeIn"); void c.offsetWidth; c.classList.add("fadeIn");
  const img = document.getElementById("newsImg");
if(item && item.imageUrl){
  img.src = item.imageUrl;
  img.style.display = "block";
} else {
  img.removeAttribute("src");
  img.style.display = "none";
}

  if(!item){
    $("headline").textContent = "Sem notÃ­cias";
    $("summary").textContent = "Verifique se data/news.json tem items[].";
    $("sourceChip").textContent = "Fonte: â€”";
    $("timeChip").textContent = "Publicado: â€”";
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt);
    return;
  }

  $("headline").textContent = clampText(item.title, 90);
  $("summary").textContent = clampText(item.summary || "", 160);
  $("sourceChip").textContent = "Fonte: " + (item.source || "â€”");
  $("timeChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "â€”");
  $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt);

  setLastId(item.id || "");
}

async function start(){
  try{
    const pack = await loadNews();
    render(pickNext(pack.items), pack.generatedAt);
    setInterval(async ()=>{
      const p = await loadNews();
      render(pickNext(p.items), p.generatedAt);
    }, ROTATE_SECONDS*1000);
  }catch(e){
    render(null, new Date().toISOString());
  }
}
start();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
