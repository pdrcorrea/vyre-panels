<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView â€¢ NotÃ­cias</title>
  <link rel="stylesheet" href="./pv.css">
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">PV</div>
        <div>
          <h1>NotÃ­cias locais</h1>
          <p>Imagem + manchete + fonte â€¢ atualizaÃ§Ã£o automÃ¡tica</p>
        </div>
      </div>
      <div class="status">
        <div class="pill"><span class="dot" id="netDot"></span><span id="netText">Online</span></div>
        <div class="pill"><span id="clockNow">--:--</span></div>
        <div class="pill">Troca: <span id="rot">20</span>s</div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="cardTop">
          <div class="tag"><span class="icon">ðŸ“°</span><span>NotÃ­cia</span></div>
          <div class="pill" id="hint">Leve â€¢ Ãºtil â€¢ sem sensacionalismo</div>
        </div>

        <div class="content fadeIn" id="content">
          <img id="newsImg" alt="" style="width:100%; max-height:48vh; object-fit:cover; border-radius:14px; border:1px solid rgba(255,255,255,.10); display:none;">
          <div class="headline" id="headline">Carregandoâ€¦</div>
          <div class="summary" id="summary">Aguarde.</div>

          <div class="metaRow" id="metaRow">
            <div class="metaChip" id="sourceChip">Fonte: â€”</div>
            <div class="metaChip" id="timeChip">Publicado: â€”</div>
          </div>
        </div>

        <div class="footer">
          <div>PontoView â€¢ Vyre</div>
          <div id="footerRight">Atualizado: â€”</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const ROTATE_SECONDS = 20;
  document.getElementById("rot").textContent = ROTATE_SECONDS;

  const $ = (id)=>document.getElementById(id);

  function updateClock(){
    $("clockNow").textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  setInterval(updateClock, 1000); updateClock();

  function setNetUI(online){
    $("netDot").classList.toggle("off", !online);
    $("netText").textContent = online ? "Online" : "Offline";
  }
  setNetUI(navigator.onLine);
  addEventListener("online",()=>setNetUI(true));
  addEventListener("offline",()=>setNetUI(false));

  function fmtDateTime(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch{return "â€”";}
  }
  function clampText(txt,max){
    if(!txt) return "";
    const s = String(txt).replace(/\s+/g," ").trim();
    return s.length>max ? s.slice(0,max-1)+"â€¦" : s;
  }

  const STORAGE_LAST = "pv_news_last_id_v2";

  function getLastId(){ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} }
  function setLastId(id){ try{localStorage.setItem(STORAGE_LAST, id||"")}catch{} }

  function renderError(message){
    const img = $("newsImg");
    img.style.display = "none";
    img.removeAttribute("src");

    $("headline").textContent = "Sem notÃ­cias";
    $("summary").textContent = message || "NÃ£o foi possÃ­vel carregar data/news.json.";
    $("sourceChip").textContent = "Fonte: â€”";
    $("timeChip").textContent = "Publicado: â€”";
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(new Date().toISOString());
  }

  function pickNext(items){
    if(!items || !items.length) return null;
    const last = getLastId();
    const shuffled = items.slice().sort(()=>Math.random()-0.5);
    return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
  }

  function renderItem(item, generatedAt){
    const c = $("content");
    c.classList.remove("fadeIn"); void c.offsetWidth; c.classList.add("fadeIn");

    if(!item){
      renderError("O arquivo data/news.json existe, mas veio vazio (items[]).");
      $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt);
      return;
    }

    const img = $("newsImg");
    const imgUrl = item.imageUrl || "";

    if(imgUrl){
      img.src = imgUrl;
      img.style.display = "block";
    } else {
      img.removeAttribute("src");
      img.style.display = "none";
    }

    $("headline").textContent = clampText(item.title, 90);
    $("summary").textContent = clampText(item.summary || "", 170); // se summary nÃ£o existir, fica sÃ³ manchete
    $("sourceChip").textContent = "Fonte: " + (item.source || "â€”");
    $("timeChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "â€”");
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt);

    setLastId(item.id || "");
  }

  async function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  async function loadNews(){
    // cache-bust sempre (evita SW/cache preso)
    const url = "./data/news.json?v=" + Date.now();
    const data = await fetchWithTimeout(url, 12000);

    const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    const generatedAt = (data && data.generatedAt) ? data.generatedAt : new Date().toISOString();

    return { items, generatedAt };
  }

  async function cycle(){
    try{
      const pack = await loadNews();
      const next = pickNext(pack.items);
      renderItem(next, pack.generatedAt);
    } catch(e){
      renderError("Falha ao carregar notÃ­cias. Verifique se data/news.json estÃ¡ vÃ¡lido e publicado.");
    }
  }

  // primeira renderizaÃ§Ã£o
  cycle();
  // rotaÃ§Ãµes
  setInterval(cycle, ROTATE_SECONDS * 1000);

  // âœ… Importante: registre o SW, mas ele nÃ£o deve impedir a pÃ¡gina de rodar
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
