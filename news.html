<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView â€¢ NotÃ­cias</title>
  <link rel="stylesheet" href="./pv.css">
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">PV</div>
        <div>
          <h1>NotÃ­cias locais</h1>
          <p>Manchetes leves e Ãºteis â€¢ com imagem quando disponÃ­vel</p>
        </div>
      </div>

      <div class="status">
        <div class="pill"><span class="dot" id="netDot"></span><span id="netText">Online</span></div>
        <div class="pill"><span id="clockNow">--:--</span></div>
        <div class="pill">Troca: <span id="rot">20</span>s</div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="cardTop">
          <div class="tag">
            <span class="icon">ðŸ“°</span>
            <span>NotÃ­cia</span>
          </div>
          <div class="pill" id="hint">Fonte visÃ­vel â€¢ sem sensacionalismo</div>
        </div>

        <div class="content fadeIn" id="content">
          <!-- Imagem opcional -->
          <img
            id="newsImg"
            alt=""
            style="
              width:100%;
              max-height:46vh;
              object-fit:cover;
              border-radius:14px;
              border:1px solid rgba(255,255,255,.10);
              display:none;
            "
          >

          <!-- Manchete (SEM corte) -->
          <div class="headline" id="headline">Carregandoâ€¦</div>

          <!-- Resumo (se existir no JSON) -->
          <div class="summary" id="summary" style="display:none;"></div>

          <div class="metaRow" id="metaRow">
            <div class="metaChip" id="sourceChip">Fonte: â€”</div>
            <div class="metaChip" id="timeChip">Publicado: â€”</div>
          </div>
        </div>

        <div class="footer">
          <div>PontoView â€¢ Vyre</div>
          <div id="footerRight">Atualizado: â€”</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const ROTATE_SECONDS = 20;
  document.getElementById("rot").textContent = ROTATE_SECONDS;

  const $ = (id)=>document.getElementById(id);

  // relÃ³gio
  function updateClock(){
    $("clockNow").textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  setInterval(updateClock, 1000); updateClock();

  // status online/offline
  function setNetUI(online){
    $("netDot").classList.toggle("off", !online);
    $("netText").textContent = online ? "Online" : "Offline";
  }
  setNetUI(navigator.onLine);
  addEventListener("online",()=>setNetUI(true));
  addEventListener("offline",()=>setNetUI(false));

  function fmtDateTime(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch{return "â€”";}
  }

  const STORAGE_LAST = "pv_news_last_id_v3";

  function getLastId(){ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} }
  function setLastId(id){ try{return localStorage.setItem(STORAGE_LAST, id||"")}catch{} }

  function renderFallback(message, generatedAt){
    const img = $("newsImg");
    img.style.display = "none";
    img.removeAttribute("src");

    $("headline").textContent = "Sem notÃ­cias no momento";
    const summaryEl = $("summary");
    summaryEl.style.display = "block";
    summaryEl.textContent = message || "Confira novamente em instantes.";

    $("sourceChip").textContent = "Fonte: â€”";
    $("timeChip").textContent = "Publicado: â€”";
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt || new Date().toISOString());
  }

  function pickNext(items){
    if(!items || !items.length) return null;
    const last = getLastId();
    const shuffled = items.slice().sort(()=>Math.random()-0.5);
    return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
  }

  function renderItem(item, generatedAt){
    const c = $("content");
    c.classList.remove("fadeIn"); void c.offsetWidth; c.classList.add("fadeIn");

    if(!item){
      renderFallback("O arquivo data/news.json veio vazio (items[]).", generatedAt);
      return;
    }

    // imagem opcional
    const img = $("newsImg");
    if(item.imageUrl){
      img.src = item.imageUrl;
      img.style.display = "block";
    } else {
      img.style.display = "none";
      img.removeAttribute("src");
    }

    // manchete COMPLETA (sem clamp)
    $("headline").textContent = item.title || "NotÃ­cia";

    // resumo opcional (se vocÃª quiser usar no futuro)
    const summaryEl = $("summary");
    if(item.summary && String(item.summary).trim()){
      summaryEl.style.display = "block";
      summaryEl.textContent = String(item.summary).trim();
    } else {
      summaryEl.style.display = "none";
      summaryEl.textContent = "";
    }

    $("sourceChip").textContent = "Fonte: " + (item.source || "â€”");
    $("timeChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "â€”");
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt);

    setLastId(item.id || "");
  }

  async function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  async function loadNews(){
    const url = "./data/news.json?v=" + Date.now(); // evita cache preso
    const data = await fetchWithTimeout(url, 12000);

    const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    const generatedAt = data?.generatedAt ? data.generatedAt : new Date().toISOString();

    return { items, generatedAt };
  }

  async function cycle(){
    try{
      const pack = await loadNews();
      renderItem(pickNext(pack.items), pack.generatedAt);
    } catch {
      renderFallback("Falha ao carregar notÃ­cias. Verifique se data/news.json estÃ¡ publicado.", new Date().toISOString());
    }
  }

  cycle();
  setInterval(cycle, ROTATE_SECONDS * 1000);

  // mantÃ©m offline (se vocÃª quiser)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
