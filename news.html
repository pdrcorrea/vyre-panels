<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vyre ‚Ä¢ Not√≠cias</title>

  <style>
    :root{
      --blue1:#0b5cff;
      --blue2:#5aa3ff;
      --bg1:#0b1220;
      --bg2:#08101f;
      --card:#ffffff;
      --line: rgba(15,27,45,.10);
      --text:#0f1b2d;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:var(--text);

      /* fundo padr√£o √¥nibus */
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(90,163,255,.18), rgba(0,0,0,0) 55%),
        radial-gradient(1000px 800px at 82% 25%, rgba(11,92,255,.16), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, var(--bg1), #0a1324 55%, var(--bg2));
      background-attachment: fixed;

      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }

    .wrap{ width:min(1480px, 96vw); height:min(860px, 96vh); }

    .card{
      width:100%;
      height:100%;
      background:var(--card);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: 0 16px 40px rgba(10,30,70,.18);
      display:flex;
      flex-direction:column;
    }

    /* header degrad√™ integrado */
    .header{
      background: linear-gradient(135deg, var(--blue1), var(--blue2));
      color:#fff;
      padding: 18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 18px;
    }
    .brand{ display:flex; align-items:center; gap:14px; min-width: 320px; }
    .brandIcon{
      width:44px;height:44px;
      border-radius: 14px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.24);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 20px;
    }
    .brandTitle{ display:flex; flex-direction:column; gap:4px; }
    .brandTitle .h1{ font-weight: 1000; letter-spacing:.02em; font-size: 28px; line-height:1; margin:0; }
    .brandTitle .sub{ font-weight: 900; opacity:.92; font-size: 12px; letter-spacing: .16em; }

    .topRight{ display:flex; align-items:flex-start; gap:12px; }
    .clockWrap{ text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    .clock{ font-size: 34px; font-weight: 1000; line-height:1; letter-spacing:.02em; padding: 4px 6px; }

    /* Badge glass abaixo do rel√≥gio */
    .statusGlass{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      font-weight: 950;
      letter-spacing:.03em;
      white-space:nowrap;
      backdrop-filter: blur(6px);
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      position:relative;
      background:#38d16a;
      box-shadow: 0 0 0 0 rgba(56,209,106,.55);
      animation: pulse 1.6s ease-out infinite;
      flex:none;
    }
    .dot.offline{
      background:#ff4b4b;
      box-shadow: 0 0 0 0 rgba(255,75,75,.55);
      animation: pulseRed 1.6s ease-out infinite;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(56,209,106,.55); }
      70%{ box-shadow: 0 0 0 10px rgba(56,209,106,0); }
      100%{ box-shadow: 0 0 0 0 rgba(56,209,106,0); }
    }
    @keyframes pulseRed{
      0%{ box-shadow: 0 0 0 0 rgba(255,75,75,.55); }
      70%{ box-shadow: 0 0 0 10px rgba(255,75,75,0); }
      100%{ box-shadow: 0 0 0 0 rgba(255,75,75,0); }
    }

    /* strip */
    .strip{
      padding: 10px 18px;
      border-bottom: 1px solid var(--line);
      background: #f3f6fb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight: 1000;
      letter-spacing:.14em;
      font-size: 12px;
    }
    .stripRight{ color: rgba(15,27,45,.65); letter-spacing:.18em; }

    /* hero ocupa tudo */
    .main{ flex:1; padding: 16px; min-height:0; }
    .hero{
      height:100%;
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      position:relative;
      background: #eaf0ff;
    }
    .heroImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      object-position: center;
      display:block;
      transform: translateZ(0);
    }
    .heroShade{
      position:absolute;
      inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.55) 70%, rgba(0,0,0,.70));
      pointer-events:none;
    }

    .heroText{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 16px;
      z-index: 2;
      color: #fff;
      text-shadow: 0 10px 26px rgba(0,0,0,.45);
    }
    .headline{
      font-weight: 1000;
      font-size: 52px;
      line-height: 1.07;
      margin: 0 0 12px 0;
    }

    .metaRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,255,255,.25);
      color: rgba(15,27,45,.88);
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.02em;
      white-space:nowrap;
      backdrop-filter: blur(2px);
    }
    .chipSource img{
      width:18px;height:18px;
      border-radius: 6px;
      object-fit: contain;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15,27,45,.10);
    }
    .chipSource .name{
      max-width: 320px;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* transi√ß√£o suave ao carregar */
    .fadeIn{ animation: fade .38s ease-out both; }
    @keyframes fade{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform:none; }
    }

    @media (max-width: 1100px){
      .headline{ font-size: 42px; }
      .brandTitle .h1{ font-size: 24px; }
    }
    @media (max-width: 780px){
      .headline{ font-size: 32px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="header">
        <div class="brand">
          <div class="brandIcon" aria-hidden="true">üóûÔ∏è</div>
          <div class="brandTitle">
            <div class="h1">NOT√çCIAS</div>
            <div class="sub">ESP√çRITO SANTO</div>
          </div>
        </div>

        <div class="topRight">
          <div class="clockWrap">
            <div class="clock" id="clockNow">--:--</div>

            <div class="statusGlass" id="statusBadge">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Online</span>
            </div>
          </div>
        </div>
      </div>

      <div class="strip">
        <div>MANCHETE ATUAL</div>
        <div class="stripRight">LOCAL ‚Ä¢ ES ‚Ä¢ BR</div>
      </div>

      <div class="main">
        <div class="hero fadeIn" id="hero">
          <img class="heroImg" id="heroImg" alt="" />
          <div class="heroShade"></div>

          <div class="heroText">
            <h2 class="headline" id="headline">Carregando‚Ä¶</h2>

            <div class="metaRow">
              <div class="chip chipSource" id="chipSource">
                <img id="sourceLogo" alt="">
                <span class="name" id="sourceName">Fonte</span>
              </div>

              <div class="chip" id="dateChip">Publicado: ‚Äî</div>
              <div class="chip" id="scopeChip">Tipo: ‚Äî</div>
              <div class="chip" id="cityChip" style="display:none;">Cidade: ‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <div class="pvFooter"></div>
    </div>
  </div>

  <script src="./pv-footer.js"></script>

  <script>
    const DATA_URL = "./data/news.json";
    const $ = (id)=>document.getElementById(id);

    function hhmm(d=new Date()){
      return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    }
    function fmtDateTime(iso){
      try{
        const dt = new Date(iso);
        return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
      }catch{ return "‚Äî"; }
    }
    function scopeLabel(s){
      return s === "local" ? "Local" : s === "state" ? "Estadual" : "Nacional";
    }

    function updateClock(){ $("clockNow").textContent = hhmm(); }
    setInterval(updateClock, 1000); updateClock();

    // ===== ONLINE/OFFLINE =====
    function setOnlineUI(isOnline){
      const dot = $("statusDot");
      const txt = $("statusText");
      if(isOnline){
        dot.classList.remove("offline");
        txt.textContent = "Online";
      }else{
        dot.classList.add("offline");
        txt.textContent = "Offline";
      }
    }

    // navegador / TV
    window.addEventListener("online",  () => setOnlineUI(true));
    window.addEventListener("offline", () => setOnlineUI(false));
    setOnlineUI(navigator.onLine);

    async function loadNews(){
      // se falhar fetch, consideramos offline (pra demo fica coerente)
      const res = await fetch(DATA_URL + "?v=" + Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      return { items, generatedAt: data.generatedAt || new Date().toISOString() };
    }

    // Pr√≥xima not√≠cia s√≥ muda ao recarregar
    const STORAGE_LAST = "pv_news_last_id_single_v2";
    const getLastId = ()=>{ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} };
    const setLastId = (id)=>{ try{localStorage.setItem(STORAGE_LAST, id||"")}catch{} };

    function pickNext(items){
      if(!items.length) return null;
      const last = getLastId();
      const shuffled = items.slice().sort(()=>Math.random()-0.5);
      return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
    }

    // ===== CAPA GERADA (GARANTE IMAGEM SEMPRE) =====
    function fitLines(ctx, text, maxWidth){
      const words = (text || "").split(/\s+/).filter(Boolean);
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? (line + " " + w) : w;
        if(ctx.measureText(test).width <= maxWidth){
          line = test;
        }else{
          if(line) lines.push(line);
          line = w;
        }
      }
      if(line) lines.push(line);
      return lines;
    }

    function makeCoverDataUrl(item){
      const W = 1600, H = 900;
      const c = document.createElement("canvas");
      c.width = W; c.height = H;
      const ctx = c.getContext("2d");

      // fundo degrad√™ (padr√£o PontoView)
      const g = ctx.createLinearGradient(0,0,W,H);
      g.addColorStop(0, "#0b5cff");
      g.addColorStop(1, "#5aa3ff");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      // brilho suave
      const rg = ctx.createRadialGradient(W*0.25, H*0.20, 50, W*0.25, H*0.20, H*0.9);
      rg.addColorStop(0, "rgba(255,255,255,.22)");
      rg.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = rg;
      ctx.fillRect(0,0,W,H);

      // faixa escura embaixo para o texto
      const shade = ctx.createLinearGradient(0,H*0.45,0,H);
      shade.addColorStop(0, "rgba(0,0,0,0)");
      shade.addColorStop(1, "rgba(0,0,0,.65)");
      ctx.fillStyle = shade;
      ctx.fillRect(0,0,W,H);

      // t√≠tulo
      const padding = 70;
      const maxW = W - padding*2;
      ctx.fillStyle = "rgba(255,255,255,.98)";
      ctx.textBaseline = "top";

      let fontSize = 74;
      ctx.font = `900 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      let lines = fitLines(ctx, item?.title || "Not√≠cia", maxW);

      // ajusta fonte para caber (at√© 4 linhas)
      while((lines.length > 4) && fontSize > 44){
        fontSize -= 6;
        ctx.font = `900 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        lines = fitLines(ctx, item?.title || "Not√≠cia", maxW);
      }

      const startY = H - padding - (lines.length * (fontSize * 1.12)) - 70;
      let y = Math.max(H*0.50, startY);

      for(let i=0;i<Math.min(lines.length, 4);i++){
        ctx.fillText(lines[i], padding, y);
        y += fontSize * 1.12;
      }

      // fonte (pequena)
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.font = `700 30px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      const src = (item?.source || item?.sourceDomain || "Fonte");
      ctx.fillText(src, padding, H - padding + 8);

      return c.toDataURL("image/jpeg", 0.92);
    }

    // tenta carregar imagem real; se falhar, gera capa (sempre)
    function setHeroImage(item){
      const img = $("heroImg");
      img.onerror = null;

      const url = item?.imageUrl || item?.imageLocal || item?.imageRemote || "";
      const fallback = makeCoverDataUrl(item);

      if(!url){
        img.src = fallback;
        return;
      }

      // 1) tenta a imagem da not√≠cia
      img.src = url;

      // 2) se falhar, usa a capa gerada (garante demo)
      img.onerror = () => {
        img.onerror = null;
        img.src = fallback;
      };

      // 3) se demorar demais (TV / rede), tamb√©m cai no fallback
      const timeoutMs = 3500;
      const t = setTimeout(() => {
        // se ainda est√° tentando carregar (complete false), troca pro fallback
        if(!img.complete || img.naturalWidth === 0){
          img.onerror = null;
          img.src = fallback;
        }
      }, timeoutMs);

      img.onload = () => clearTimeout(t);
    }

    function setSource(item){
      const logo = $("sourceLogo");
      const name = $("sourceName");
      const label = item?.source || item?.sourceDomain || "Fonte";
      name.textContent = label;

      const logoUrl = item?.sourceLogoUrl || "";
      logo.onerror = null;

      if(logoUrl){
        logo.style.display = "inline-block";
        logo.src = logoUrl;
        logo.alt = label;
        logo.onerror = () => { logo.style.display = "none"; };
      }else{
        logo.style.display = "none";
      }
    }

    function render(item){
      const hero = $("hero");
      hero.classList.remove("fadeIn"); void hero.offsetWidth; hero.classList.add("fadeIn");

      if(!item){
        $("headline").textContent = "Sem not√≠cias recentes no momento";
        $("dateChip").textContent = "Publicado: ‚Äî";
        $("scopeChip").textContent = "Tipo: ‚Äî";
        $("cityChip").style.display = "none";
        $("sourceLogo").style.display = "none";
        $("sourceName").textContent = "Fonte";
        // garante uma capa mesmo no vazio
        $("heroImg").src = makeCoverDataUrl({ title: "Sem not√≠cias recentes", source: "PontoView" });
        return;
      }

      $("headline").textContent = item.title || "Not√≠cia";
      $("dateChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "‚Äî");
      $("scopeChip").textContent = "Tipo: " + scopeLabel(item.scope);

      if(item.city){
        $("cityChip").style.display = "inline-flex";
        $("cityChip").textContent = "Cidade: " + item.city;
      }else{
        $("cityChip").style.display = "none";
      }

      setSource(item);
      setHeroImage(item);
      setLastId(item.id || "");
    }

    async function start(){
      try{
        const pack = await loadNews();
        setOnlineUI(true);
        const item = pickNext(pack.items || []);
        render(item);
      }catch{
        setOnlineUI(false);
        render(null);
      }
    }

    start();
  </script>
</body>
</html>
