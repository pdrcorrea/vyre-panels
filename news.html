<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView ‚Ä¢ Not√≠cias</title>
  <link rel="stylesheet" href="./pv.css">
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">PV</div>
        <div>
          <h1>Not√≠cias locais</h1>
          <p>Layout TV ‚Ä¢ imagem + manchete + fonte</p>
        </div>
      </div>

      <div class="status">
        <div class="pill"><span class="dot" id="netDot"></span><span id="netText">Online</span></div>
        <div class="pill"><span id="clockNow">--:--</span></div>
        <div class="pill">Troca: <span id="rot">20</span>s</div>
      </div>
    </div>

    <div class="main">
      <div class="card" style="padding:18px;">
        <div class="cardTop" style="padding:4px 4px 10px 4px;">
          <div class="tag"><span class="icon">üì∞</span><span>Not√≠cia</span></div>
          <div class="pill" id="hint">Leve ‚Ä¢ √∫til ‚Ä¢ sem sensacionalismo</div>
        </div>

        <div class="newsGrid fadeIn" id="content">
          <!-- ESQUERDA: IMAGEM -->
          <div class="newsLeft">
            <div class="newsMedia">
              <img id="newsImg" alt="" style="display:none;">
              <div class="newsMediaEmpty" id="newsImgEmpty">
                <div>
                  <div style="font-size:44px; margin-bottom:10px;">üóûÔ∏è</div>
                  <div>Sem imagem para esta not√≠cia</div>
                </div>
              </div>
            </div>
          </div>

          <!-- DIREITA: TEXTO -->
          <div class="newsRight">
            <div>
              <div class="newsHeadline" id="headline">Carregando‚Ä¶</div>
            </div>

            <div class="newsMeta">
              <div class="metaChip" id="sourceChip">Fonte: ‚Äî</div>
              <div class="metaChip" id="timeChip">Publicado: ‚Äî</div>
              <div class="metaChip" id="countChip">Itens: ‚Äî</div>
            </div>
          </div>
        </div>

        <!-- TICKER -->
        <div class="ticker" aria-label="Ticker de manchetes">
          <div class="tickerLabel"><span style="font-size:20px;">üü¶</span>DESTAQUES</div>
          <div class="tickerTrack">
            <div class="tickerText" id="tickerText">Carregando manchetes‚Ä¶</div>
          </div>
        </div>

        <div class="footer" style="margin-top:14px;">
          <div>PontoView ‚Ä¢ Vyre</div>
          <div id="footerRight">Atualizado: ‚Äî</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const ROTATE_SECONDS = 20;
  document.getElementById("rot").textContent = ROTATE_SECONDS;

  const $ = (id)=>document.getElementById(id);

  function updateClock(){
    $("clockNow").textContent = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  setInterval(updateClock, 1000); updateClock();

  function setNetUI(online){
    $("netDot").classList.toggle("off", !online);
    $("netText").textContent = online ? "Online" : "Offline";
  }
  setNetUI(navigator.onLine);
  addEventListener("online",()=>setNetUI(true));
  addEventListener("offline",()=>setNetUI(false));

  function fmtDateTime(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch{return "‚Äî";}
  }

  const STORAGE_LAST = "pv_news_last_id_tv_v1";
  function getLastId(){ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} }
  function setLastId(id){ try{return localStorage.setItem(STORAGE_LAST, id||"")}catch{} }

  function pickNext(items){
    if(!items || !items.length) return null;
    const last = getLastId();
    const shuffled = items.slice().sort(()=>Math.random()-0.5);
    return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
  }

  function setImage(url){
    const img = $("newsImg");
    const empty = $("newsImgEmpty");
    if(url){
      img.src = url;
      img.style.display = "block";
      empty.style.display = "none";
    } else {
      img.removeAttribute("src");
      img.style.display = "none";
      empty.style.display = "grid";
    }
  }

  function buildTicker(items){
    if(!items || !items.length) return "Sem manchetes no momento ‚Ä¢";
    // pega at√© 8 t√≠tulos e junta
    const titles = items.slice(0, 8).map(x => x.title).filter(Boolean);
    return (titles.join("  ‚Ä¢  ") + "  ‚Ä¢  ");
  }

  function restartTicker(text){
    const el = $("tickerText");
    el.style.animation = "none";
    el.textContent = text;
    // reflow
    void el.offsetWidth;
    el.style.animation = "";
  }

  function renderFallback(generatedAt){
    setImage("");
    $("headline").textContent = "Sem not√≠cias no momento";
    $("sourceChip").textContent = "Fonte: ‚Äî";
    $("timeChip").textContent = "Publicado: ‚Äî";
    $("countChip").textContent = "Itens: 0";
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(generatedAt || new Date().toISOString());
    restartTicker("Sem manchetes no momento ‚Ä¢");
  }

  function renderItem(item, pack){
    const content = $("content");
    content.classList.remove("fadeIn"); void content.offsetWidth; content.classList.add("fadeIn");

    if(!item){
      renderFallback(pack.generatedAt);
      return;
    }

    setImage(item.imageUrl || "");
    $("headline").textContent = item.title || "Not√≠cia";
    $("sourceChip").textContent = "Fonte: " + (item.source || "‚Äî");
    $("timeChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "‚Äî");
    $("countChip").textContent = "Itens: " + (pack.items?.length || 0);
    $("footerRight").textContent = "Atualizado: " + fmtDateTime(pack.generatedAt);

    setLastId(item.id || "");
    restartTicker(buildTicker(pack.items));
  }

  async function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  async function loadNews(){
    const url = "./data/news.json?v=" + Date.now();
    const data = await fetchWithTimeout(url, 12000);
    const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    const generatedAt = data?.generatedAt ? data.generatedAt : new Date().toISOString();
    return { items, generatedAt };
  }

  async function cycle(){
    try{
      const pack = await loadNews();
      const item = pickNext(pack.items);
      renderItem(item, pack);
    }catch{
      renderFallback(new Date().toISOString());
    }
  }

  cycle();
  setInterval(cycle, ROTATE_SECONDS * 1000);

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
