<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Notícias • Vyre</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>

<style>
/* ===== VARIÁVEIS (IGUAIS ÔNIBUS) ===== */
:root{
  --header: linear-gradient(180deg,#2f6f9d 0%,#184c75 55%,#0f3b5e 100%);
  --bg: radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22), rgba(10,46,62,0) 60%),
        radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14), rgba(6,18,24,0) 65%),
        radial-gradient(1400px 1100px at 50% 55%, #0a2232 0%, #081423 62%, #040a0f 100%);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  display:grid;
  place-items:center;
  padding:20px;
}

/* ===== PANEL ===== */
.panel{
  width:min(1500px,96vw);
  height:calc(100vh - 40px);
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 18px 60px rgba(2,10,23,.18);
  display:flex;
  flex-direction:column;
  animation:fade .7s ease forwards;
}
@keyframes fade{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

/* ===== HEADER (COPIADO DO ÔNIBUS) ===== */
.header{
  padding:14px 22px;
  background:var(--header);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.h-left{display:flex;gap:14px;align-items:center}
.busIcon{
  width:44px;height:44px;border-radius:14px;
  display:grid;place-items:center;
  background:rgba(255,255,255,.1);
}
.title{font-size:28px;font-weight:900;letter-spacing:.06em}
.sub{font-size:12px;font-weight:800;letter-spacing:.14em;opacity:.9}

.h-right{text-align:right}
.clock{font-size:52px;font-weight:900}
.status{
  margin-top:6px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.14);
  font-size:12px;
  font-weight:900;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:#22c55e;
  animation:pulse 1.5s infinite;
}
.off{background:#ef4444}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(34,197,94,.6)}
  70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}
}

/* ===== SUBSTRIP ===== */
.substrip{
  background:#f3f7ff;
  padding:10px 22px;
  font-size:12px;
  font-weight:900;
  letter-spacing:.14em;
  display:flex;
  justify-content:space-between;
}

/* ===== HERO ===== */
.hero{
  position:relative;
  flex:1;
  overflow:hidden;
}
.hero img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}
.overlay{
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,transparent 40%,rgba(0,0,0,.85));
}
.content{
  position:absolute;
  bottom:20px;
  left:22px;
  right:22px;
  color:#fff;
}
.headline{
  font-size:52px;
  font-weight:900;
  line-height:1.08;
}
.meta{
  margin-top:14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.chip{
  background:rgba(255,255,255,.88);
  color:#0f172a;
  padding:8px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:8px;
}
.chip img{
  width:18px;height:18px;object-fit:contain;
}

/* ===== FOOTER ===== */
.footer{
  padding:10px 22px;
  display:flex;
  justify-content:flex-end;
}
.footer img{height:22px;opacity:.75}
</style>
</head>

<body>
<section class="panel">

  <!-- HEADER -->
  <div class="header">
    <div class="h-left">
      <div class="busIcon"><span class="material-icons-outlined">newspaper</span></div>
      <div>
        <div class="title">NOTÍCIAS</div>
        <div class="sub">ESPÍRITO SANTO</div>
      </div>
    </div>
    <div class="h-right">
      <div class="clock" id="clock">--:--</div>
      <div class="status">
        <span class="dot" id="dot"></span>
        <span id="statusText">Online</span>
      </div>
    </div>
  </div>

  <div class="substrip">
    <span>MANCHETE ATUAL</span>
    <span><span id="scopeLabel">LOCAL • ES • BR</span>
  </div>

  <div class="hero">
    <img id="image"/>
    <div class="overlay"></div>
    <div class="content">
      <div class="headline" id="title">Carregando…</div>
      <div class="meta">
        <div class="chip">
          <img id="logo"/>
          <span id="source">Fonte</span>
        </div>
        <div class="chip" id="date"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <img src="./assets/logo-pontoview.png"/>
  </div>

</section>

<script>
/* ===== CLOCK ===== */
const clock = document.getElementById("clock");
setInterval(() => {
  clock.textContent = new Date().toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
}, 1000);

/* ===== ONLINE / OFFLINE ===== */
const statusText = document.getElementById("statusText");
const dot = document.getElementById("dot");
function updateStatus() {
  if (navigator.onLine) {
    statusText.textContent = "Online";
    dot.classList.remove("off");
  } else {
    statusText.textContent = "Offline";
    dot.classList.add("off");
  }
}
window.addEventListener("online", updateStatus);
window.addEventListener("offline", updateStatus);
updateStatus();

/* ===== IMAGE PROXY (HOTLINK/CORS) =====
   wsrv.nl re-hospeda a imagem e evita a maioria dos bloqueios de hotlink.
*/
function proxy(url) {
  if (!url) return null;
  const clean = String(url).trim();
  if (!clean || clean === "null" || clean === "undefined") return null;

  // Se já for wsrv, não duplica
  if (clean.includes("wsrv.nl/?url=")) return clean;

  // wsrv.nl prefere sem o protocolo em alguns casos
  const noProto = clean.replace(/^https?:\/\//i, "");
  return "https://wsrv.nl/?url=" + encodeURIComponent(noProto) + "&w=1200&fit=cover&output=webp";
}

const FALLBACK_IMG = "https://images.unsplash.com/photo-1504711432869-0df30a7e04ad?auto=format&fit=crop&w=1200&q=70";

/* ===== LOAD NEWS ===== */
fetch("./data/news.json?" + Date.now())
  .then(r => r.json())
  .then(data => {
    const rawItems = Array.isArray(data.items) ? data.items : [];
    if (!rawItems.length) return;

    // Normaliza (suporta formatos antigos caso existam)
    const items = rawItems
      .map(it => ({
        title: typeof it.title === "string" ? it.title : (it.title?.title || it.title?.text || "Notícia"),
        source: typeof it.source === "string" ? it.source : (it.source?.name || it.source?.title || "Notícias"),
        image: typeof it.image === "string" ? it.image : (it.image?.url || it.image?.image || null),
        url: it.url || null,
        scope: it.scope || "national",
        city: it.city || null
      }))
      .filter(it => it.title);

    // Agrupa por escopo para alternar sem mudar o layout
    const byScope = items.reduce((acc, it) => {
      const k = it.scope || "national";
      (acc[k] ||= []).push(it);
      return acc;
    }, {});

    const scopeOrder = ["local", "state", "national", "health"].filter(s => (byScope[s] || []).length);
    if (!scopeOrder.length) scopeOrder.push("national");

    let scopeIdx = 0;
    const perScopeIdx = Object.fromEntries(scopeOrder.map(s => [s, 0]));

    const titleEl = document.getElementById("title");
    const sourceEl = document.getElementById("source");
    const imgEl = document.getElementById("image");
    const logoEl = document.getElementById("logo");
    const scopeLabelEl = document.getElementById("scopeLabel");

    function prettyScopeLabel(scope, city) {
      if (scope === "local") return city ? `LOCAL • ${city}` : "LOCAL";
      if (scope === "state") return "ES";
      if (scope === "health") return "SAÚDE";
      return "BR";
    }

    function setHeroImage(url) {
      const finalUrl = proxy(url) || FALLBACK_IMG;

      // Preload para evitar "piscadas"
      const pre = new Image();
      pre.onload = () => {
        imgEl.src = finalUrl;
        imgEl.style.display = "block";
      };
      pre.onerror = () => {
        imgEl.src = FALLBACK_IMG;
        imgEl.style.display = "block";
      };
      pre.src = finalUrl;
    }

    imgEl.addEventListener("error", () => {
      // fallback extra caso a imagem quebre depois
      if (imgEl.src !== FALLBACK_IMG) imgEl.src = FALLBACK_IMG;
    });

    function showNext() {
      const currentScope = scopeOrder[scopeIdx];
      const list = byScope[currentScope] || [];
      const i = perScopeIdx[currentScope] % list.length;
      const item = list[i];

      titleEl.textContent = item.title;
      sourceEl.textContent = item.source || "Notícias";

      // "logo" (mantém layout: se não existir, apenas oculta)
      if (item.logo) {
        logoEl.src = item.logo;
        logoEl.style.display = "block";
      } else {
        logoEl.style.display = "none";
      }

      scopeLabelEl.textContent = prettyScopeLabel(item.scope, item.city);

      setHeroImage(item.image);

      perScopeIdx[currentScope] = i + 1;
      scopeIdx = (scopeIdx + 1) % scopeOrder.length;
    }

    showNext();
    setInterval(showNext, 15000); // 15s por manchete
  })
  .catch(() => {
    // Se falhar, ao menos mantém o painel "vivo"
    document.getElementById("title").textContent = "Sem notícias no momento";
    const imgEl = document.getElementById("image");
    if (imgEl) imgEl.src = FALLBACK_IMG;
  });
</script>
</body>
</html>
