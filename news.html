<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vyre ‚Ä¢ Not√≠cias</title>
  <link rel="stylesheet" href="./vyre-light.css">

  <style>
    /* ===== BACKGROUND (padr√£o √¥nibus) ===== */
    html, body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 18% 10%, rgba(90,163,255,.18), rgba(0,0,0,0) 55%),
                  radial-gradient(1000px 800px at 82% 25%, rgba(11,92,255,.16), rgba(0,0,0,0) 60%),
                  linear-gradient(180deg, #0b1220, #0a1324 55%, #08101f);
      background-attachment: fixed;
    }

    /* garante que o card branco continue igual */
    .page{ min-height:100%; }

    /* ===== IMAGEM: sempre se ajusta ao espa√ßo (nem menor, nem maior) ===== */
    .media{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      border-radius: inherit;
    }
    #newsImg{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;          /* preenche sem distorcer */
      object-position:center;    /* centraliza */
      transform: translateZ(0);  /* melhora render em TVs */
    }

    /* fallback centralizado e consistente */
    #newsEmpty{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      text-align:center;
    }

    /* ===== Fonte com LOGO (favicon) ===== */
    .chipLogo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:8px 10px;
    }
    .chipLogo img{
      height:18px;
      width:18px;
      border-radius:6px;
      object-fit:contain;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15,27,45,.10);
    }
    .chipLogo span{ display:none; font-weight:900; }
    .chipLogo.fallback span{ display:inline; }
    .chipLogo.fallback img{ display:none; }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <div class="brandIcon" aria-hidden="true">üóûÔ∏è</div>
          <div class="brandText">
            <h1>NOT√çCIAS</h1>
            <div class="sub">ESP√çRITO SANTO</div>
          </div>
        </div>

        <div class="clockBox">
          <div class="clockNow" id="clockNow">--:--</div>
          <div class="clockMeta">AO VIVO</div>
        </div>
      </div>

      <div class="strip">
        <div class="stripLeft">MANCHETE ATUAL</div>
        <div class="stripRight">LOCAL ‚Ä¢ ES ‚Ä¢ BR</div>
      </div>

      <div class="main">
        <div class="grid2 fadeIn" id="content">
          <div class="panel">
            <div class="media">
              <img id="newsImg" alt="" style="display:none;">
              <div class="mediaEmpty" id="newsEmpty">
                <div>
                  <div class="big">üóûÔ∏è</div>
                  <div>Sem imagem dispon√≠vel</div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="textBox">
              <div class="headline" id="headline">Carregando‚Ä¶</div>

              <div class="metaRow">
                <!-- Fonte vira LOGO -->
                <div class="chip chipLogo" id="sourceChip">
                  <img id="sourceLogo" alt="">
                  <span id="sourceText">Fonte</span>
                </div>

                <div class="chip" id="dateChip">Publicado: ‚Äî</div>
                <div class="chip" id="scopeChip">Tipo: ‚Äî</div>
                <div class="chip" id="cityChip" style="display:none;">Cidade: ‚Äî</div>
                <div class="chip" id="countChip">Itens: ‚Äî</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- footer unificado (s√≥ logo) -->
      <div class="pvFooter"></div>
    </div>
  </div>

  <script src="./pv-footer.js"></script>
  <script>
  (() => {
    const ROTATE_SECONDS = 20;
    const $ = (id)=>document.getElementById(id);

    function hhmm(d=new Date()){
      return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    }
    function fmtDateTime(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
      }catch{return "‚Äî";}
    }
    function scopeLabel(s){
      return s === "local" ? "Local" : s === "state" ? "Estadual" : "Nacional";
    }

    function updateClock(){ $("clockNow").textContent = hhmm(); }
    setInterval(updateClock, 1000); updateClock();

    const STORAGE_LAST = "pv_news_last_id_light_v3";
    const getLastId = ()=>{ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} };
    const setLastId = (id)=>{ try{localStorage.setItem(STORAGE_LAST, id||"")}catch{} };

    function pickNext(items){
      if(!items || !items.length) return null;
      const last = getLastId();
      const shuffled = items.slice().sort(()=>Math.random()-0.5);
      return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
    }

function setImage(url){
  const img = document.getElementById("newsImg");
  const empty = document.getElementById("newsEmpty");
  img.onerror = null;

  if(url){
    // garante que ./data/... funcione mesmo com cache
    img.src = url;
    img.style.display = "block";
    empty.style.display = "none";
    img.onerror = () => {
      img.removeAttribute("src");
      img.style.display = "none";
      empty.style.display = "grid";
    };
  } else {
    img.removeAttribute("src");
    img.style.display = "none";
    empty.style.display = "grid";
  }
}

    function setSourceLogo(item){
      const chip = $("sourceChip");
      const logo = $("sourceLogo");
      const text = $("sourceText");

      const label = item.source || item.sourceDomain || "Fonte";
      text.textContent = label;

      chip.classList.remove("fallback");
      logo.onerror = null;

      if (item.sourceLogoUrl) {
        logo.src = item.sourceLogoUrl;
        logo.alt = label;
        logo.onerror = () => chip.classList.add("fallback");
      } else {
        chip.classList.add("fallback");
        logo.removeAttribute("src");
      }
    }

    function renderFallback(pack){
      setImage("");
      $("headline").textContent = "Sem not√≠cias recentes no momento";
      $("dateChip").textContent = "Publicado: ‚Äî";
      $("scopeChip").textContent = "Tipo: ‚Äî";
      $("cityChip").style.display = "none";
      $("countChip").textContent = "Itens: 0";

      $("sourceChip").classList.add("fallback");
      $("sourceText").textContent = "Fonte";
      $("sourceLogo").removeAttribute("src");
    }

    function renderItem(item, pack){
      const content = $("content");
      content.classList.remove("fadeIn"); void content.offsetWidth; content.classList.add("fadeIn");

      if(!item){
        renderFallback(pack);
        return;
      }

      setImage(item.imageUrl || "");
      $("headline").textContent = item.title || "Not√≠cia";
      $("dateChip").textContent = "Publicado: " + (item.publishedAt ? fmtDateTime(item.publishedAt) : "‚Äî");
      $("scopeChip").textContent = "Tipo: " + scopeLabel(item.scope);
      $("countChip").textContent = "Itens: " + (pack.items?.length || 0);

      if (item.city) {
        $("cityChip").style.display = "inline-flex";
        $("cityChip").textContent = "Cidade: " + item.city;
      } else {
        $("cityChip").style.display = "none";
      }

      setSourceLogo(item);
      setLastId(item.id || "");
    }

    async function fetchWithTimeout(url, ms){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), ms);
      try{
        const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
        if(!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    async function loadNews(){
      const url = "./data/news.json?v=" + Date.now();
      const data = await fetchWithTimeout(url, 12000);
      const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
      const generatedAt = data?.generatedAt ? data.generatedAt : new Date().toISOString();
      return { items, generatedAt };
    }

    async function cycle(){
      try{
        const pack = await loadNews();
        renderItem(pickNext(pack.items), pack);
      }catch{
        renderFallback({ generatedAt: new Date().toISOString(), items: [] });
      }
    }

    cycle();
    setInterval(cycle, ROTATE_SECONDS * 1000);
  })();
  </script>
</body>
</html>
