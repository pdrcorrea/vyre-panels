<!-- ===== tips.html (SUBSTITUA INTEIRO) ===== -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vyre â€¢ Dicas</title>
  <link rel="stylesheet" href="./vyre-light.css">
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <div class="brandIcon" aria-hidden="true">ðŸ’¡</div>
          <div class="brandText">
            <h1>Dicas</h1>
            <div class="sub">EDUCATIVAS</div>
          </div>
        </div>

        <div class="clockBox">
          <div class="clockNow" id="clockNow">--:--</div>
          <div class="clockMeta">ATUALIZADO â€¢ <span id="clockUpd">--:--</span></div>
        </div>
      </div>

      <div class="strip">
        <div class="stripLeft">DICA DO MOMENTO</div>
        <div class="stripRight">CONTEÃšDO â€¢ LIVRE</div>
      </div>

      <div class="main">
        <div class="grid2 fadeIn" id="content">
          <div class="panel">
            <div class="media">
              <div class="mediaEmpty" style="height:100%;">
                <div class="big">ðŸ’¡</div>
                <div>Bem-estar â€¢ saÃºde â€¢ seguranÃ§a</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="textBox">
              <div class="headline" id="headline">Carregandoâ€¦</div>
              <div class="bodyText" id="body"></div>

              <div class="metaRow">
                <div class="chip" id="topicChip">Tema: â€”</div>
                <div class="chip" id="countChip">Itens: â€”</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== tips.html (MESMA ALTERAÃ‡ÃƒO) ===== -->
<div class="pvFooter"></div>
<script src="./pv-footer.js"></script>
       
      </div>
    </div>
  </div>

<script>
(() => {
  const ROTATE_SECONDS = 20;
  const $ = (id)=>document.getElementById(id);

  function hhmm(d=new Date()){
    return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  }
  function fmtDateTime(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch{return "â€”";}
  }

  function updateClock(){ $("clockNow").textContent = hhmm(); }
  setInterval(updateClock, 1000); updateClock();

  const STORAGE_LAST = "pv_tips_last_id_light_v1";
  const getLastId = ()=>{ try{return localStorage.getItem(STORAGE_LAST)||""}catch{return""} };
  const setLastId = (id)=>{ try{localStorage.setItem(STORAGE_LAST, id||"")}catch{} };

  function pickNext(items){
    if(!items || !items.length) return null;
    const last = getLastId();
    const shuffled = items.slice().sort(()=>Math.random()-0.5);
    return shuffled.find(x => (x.id||"") !== last) || shuffled[0];
  }

  function renderFallback(updatedAt){
    $("headline").textContent = "Sem dicas no momento";
    $("body").textContent = "Atualize data/tips.json para exibir conteÃºdos.";
    $("topicChip").textContent = "Tema: â€”";
    $("countChip").textContent = "Itens: 0";
    $("clockUpd").textContent = hhmm();
  }

  function renderItem(item, pack){
    const content = $("content");
    content.classList.remove("fadeIn"); void content.offsetWidth; content.classList.add("fadeIn");

    if(!item){
      renderFallback(pack.updatedAt);
      return;
    }

    $("headline").textContent = item.title || "Dica";
    $("body").textContent = item.text || item.body || "";
    $("topicChip").textContent = "Tema: " + (item.topic || item.category || "Bem-estar");
    $("clockUpd").textContent = hhmm();

    setLastId(item.id || "");
  }

  async function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    } finally { clearTimeout(t); }
  }

  async function loadTips(){
    const url = "./data/tips.json?v=" + Date.now();
    const data = await fetchWithTimeout(url, 12000);
    const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
    const updatedAt = data?.updatedAt ? data.updatedAt : new Date().toISOString();
    return { items, updatedAt };
  }

  async function cycle(){
    try{
      const pack = await loadTips();
      renderItem(pickNext(pack.items), pack);
    }catch{
      renderFallback(new Date().toISOString());
    }
  }

  cycle();
  setInterval(cycle, ROTATE_SECONDS * 1000);
})();
</script>
</body>
</html>
